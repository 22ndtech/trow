apiVersion: v1
kind: ServiceAccount
metadata:
  namespace: kube-public
  name: trow
  labels:
    app: trow
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: Role
metadata:
  namespace: kube-public
  name: trow
  labels:
    app: trow
rules:
- apiGroups:
  - ""
  resources:
  - configmaps
  verbs:
  - create
  - patch
  - get
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRole
metadata:
  namespace: kube-public
  name: trow
  labels:
    app: trow
rules:
- apiGroups:
  - certificates.k8s.io
  resources:
  - certificatesigningrequests
  verbs:
  - create
  - get
  - watch
  - delete
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: RoleBinding
metadata:
  namespace: kube-public
  name: trow
  labels:
    app: trow
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: Role
  name: trow
subjects:
- kind: ServiceAccount
  name: trow
  namespace: kube-public
---
apiVersion: rbac.authorization.k8s.io/v1beta1
kind: ClusterRoleBinding
metadata:
  namespace: kube-public
  name: trow
  labels:
    app: trow
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: trow
subjects:
- kind: ServiceAccount
  name: trow
  namespace: kube-public
---
apiVersion: apps/v1
kind: Deployment
metadata:
  name: trow-deploy
  namespace: kube-public
spec:
  selector:
    matchLabels:
      app: trow
  template:
    metadata:
      labels:
        app: trow
    spec:
      serviceAccountName: trow
      containers:
      - name: trow-pod
        image: containersol/trow:default
        imagePullPolicy: Always
        ports:
        - containerPort: 8443
        volumeMounts:
        - mountPath: /certs
          name: cert-vol
      initContainers:
      - name: trow-init
        image: containersol/trow:init
        imagePullPolicy: Always
        env:
          - name: POD_NAME
            valueFrom:
              fieldRef:
                fieldPath: metadata.name
          - name: POD_NAMESPACE
            valueFrom:
              fieldRef:
                fieldPath: metadata.namespace
          - name: POD_IP
            valueFrom:
              fieldRef:
                fieldPath: status.podIP
        volumeMounts:
        - mountPath: /certs
          name: cert-vol
      volumes:
        - name: cert-vol
          emptyDir:
            medium: Memory
---
apiVersion: v1
kind: Service
metadata:
  name: trow
  namespace: kube-public
spec:
  selector:
    app: trow
  type: NodePort
  ports:
  - protocol: TCP
    port: 443
    targetPort: 8443
    nodePort: 31000

---
apiVersion: admissionregistration.k8s.io/v1beta1
kind: ValidatingWebhookConfiguration
metadata:
  name: trow-validator
webhooks:
  - name: validator.trow.io
    rules:
      - apiGroups:
          - ""
        apiVersions:
          - v1
        operations:
          - CREATE
        resources:
          - pods
    failurePolicy: Fail
    clientConfig:
      caBundle: LS0tLS1CRUdJTiBDRVJUSUZJQ0FURS0tLS0tCk1JSUM1ekNDQWMrZ0F3SUJBZ0lCQVRBTkJna3Foa2lHOXcwQkFRc0ZBREFWTVJNd0VRWURWUVFERXdwdGFXNXAKYTNWaVpVTkJNQjRYRFRFNE1ETXlNakUxTlRZeU1Gb1hEVEk0TURNeE9URTFOVFl5TUZvd0ZURVRNQkVHQTFVRQpBeE1LYldsdWFXdDFZbVZEUVRDQ0FTSXdEUVlKS29aSWh2Y05BUUVCQlFBRGdnRVBBRENDQVFvQ2dnRUJBTTZ4CndJN0hQd2xFS21HVWZQcXZnRi9SY29OeTdxQmN1QnRrVlhvbGNOaEJ4Y0w0cmdkRUs3bVdhVm1pU0o4M3I0Um8KNlV6aWZERzhNZVJPNkw2SXhhYkJoSnR0MXBFUytydFBYN1FPZVhtamltM1R0Z251N0tCam84Y05PSGtJQ0ZqQQp0clh2cTVyM3pjaGE0OHBNbkJnVHJFajNOcTl2UGd2aTNOSlZrdmpTTW1yMTBxWlg4aHdjQ29TT2JFVlJGa0VRClpISDVDeGVib2d6cmZPSCtUOFBsbGdCaFZxRDZFeWNWOWZrYkFjUUptbG5DNllBWWJpSFhqdnFEWnpsOHYySHMKMER1TS81UXV1TnNwVEVGc3VnSzVwQW1nSXE1d2g2Y25lQzgweEdVcEsyRHRZTW9PNWtLU3lQR0tJbW05MDNSZQpuSUxlUUdISEFEek5IbGF2aitNQ0F3RUFBYU5DTUVBd0RnWURWUjBQQVFIL0JBUURBZ0trTUIwR0ExVWRKUVFXCk1CUUdDQ3NHQVFVRkJ3TUNCZ2dyQmdFRkJRY0RBVEFQQmdOVkhSTUJBZjhFQlRBREFRSC9NQTBHQ1NxR1NJYjMKRFFFQkN3VUFBNElCQVFCS3VYZFNKUFRGVEg1TVBmYmliQzNNVDFYQWpQTjhVMnBJWnlRTVFsTnhBS1RXYmhOcgpTZlk3aFNaTkpxL3lQRUhHOFpPUW13TTFZQ2U4dGRla3ZSTHdFZlFRV29CdGhRYVRNcHgwbmhKSXI2Z0VpN2JOCjNzdGkzaVpuZUgvWDVuc0VUT1VmQ1hlR2U5SnIrWEFTdmpMS3F3RHgrVDIvZzFtU1NXcVl4VG5uQzhLcTBQdnkKdCtsZGlZdEl3K1o1T0FicVByZzFnck5ic01UMkZXMlprMnYzc3ErVXRJcWdmNFpHOG1LRGVYT0xIbDcydFRRZAp0NmZSQ1NrZkxkUkhveU5HeHpIUVArRTFJY0k3U0ZCSGl3RGRBRW13YkdPWmg5L1JTNDdLai9YWWI0eXBST1NXClpoanpaRmNrNVpJYWRrTVVua1FPTkt6NkZyNHE2TjdEbi8wVwotLS0tLUVORCBDRVJUSUZJQ0FURS0tLS0tCg==
      service:
        name: trow
        namespace: kube-public
        path: "/validate-image"
